<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ ìš©ì¹´ë“œ ê´€ë¦¬ì ë„êµ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: white;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .panel h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .benefit-item, .tier-item, .fee-option-item {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .tier-item {
            background: #f0f8ff;
            border-color: #4a90e2;
        }

        .fee-option-item {
            background: #fff8f0;
            border-color: #ffa726;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .help-text {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            color: #065f46;
        }

        /* ì¹´ë“œ ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .card-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .card-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
        }

        .card-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .card-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .card-item-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .login-error {
            color: #ef4444;
            margin-top: 15px;
        }

        .hidden {
            display: none !important;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .brand-tag {
            display: inline-block;
            padding: 5px 10px;
            margin: 3px;
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .brand-tag:hover {
            background: #90caf9;
            color: white;
        }

        .affiliate-suggestions {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .card-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>ğŸ” ê´€ë¦¬ì ì¸ì¦</h2>
            <p>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <input type="password" id="passwordInput" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.key==='Enter') checkPassword()">
            <button class="login-btn" onclick="checkPassword()">ë¡œê·¸ì¸</button>
            <div id="loginError" class="login-error hidden"></div>
        </div>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <div class="header">
            <h1>ğŸ´ ì‹ ìš©ì¹´ë“œ ê´€ë¦¬ì ë„êµ¬</h1>
            <p>ì¹´ë“œ ì •ë³´ë¥¼ ì¶”ê°€í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>

        <!-- íƒ­ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('add')">ì¹´ë“œ ì¶”ê°€</button>
            <button class="tab" onclick="switchTab('list')">ì¹´ë“œ ê´€ë¦¬</button>
        </div>

        <!-- ì¹´ë“œ ì¶”ê°€ íƒ­ -->
        <div id="addTab" class="tab-content active">
            <div class="panel">
                <h2>ìƒˆ ì¹´ë“œ ë“±ë¡</h2>

                <div class="alert alert-info">
                    ğŸ’¡ ì¹´ë“œ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•˜ë©´ êµ¬ê¸€ ì‹œíŠ¸ì— ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ë™ê¸°í™”ë©ë‹ˆë‹¤.
                </div>

                <div class="form-group">
                    <label>ì¹´ë“œëª… *</label>
                    <input type="text" id="cardName" placeholder="ì˜ˆ: KBêµ­ë¯¼ My WE:SH">
                </div>

                <div class="form-group">
                    <label>ë°œê¸‰ì‚¬ *</label>
                    <select id="cardIssuer">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="KBêµ­ë¯¼ì¹´ë“œ">KBêµ­ë¯¼ì¹´ë“œ</option>
                        <option value="ì‹ í•œì¹´ë“œ">ì‹ í•œì¹´ë“œ</option>
                        <option value="ì‚¼ì„±ì¹´ë“œ">ì‚¼ì„±ì¹´ë“œ</option>
                        <option value="í˜„ëŒ€ì¹´ë“œ">í˜„ëŒ€ì¹´ë“œ</option>
                        <option value="ë¡¯ë°ì¹´ë“œ">ë¡¯ë°ì¹´ë“œ</option>
                        <option value="ìš°ë¦¬ì¹´ë“œ">ìš°ë¦¬ì¹´ë“œ</option>
                        <option value="í•˜ë‚˜ì¹´ë“œ">í•˜ë‚˜ì¹´ë“œ</option>
                        <option value="NHë†í˜‘ì¹´ë“œ">NHë†í˜‘ì¹´ë“œ</option>
                        <option value="BCì¹´ë“œ">BCì¹´ë“œ</option>
                    </select>
                </div>

                <!-- ì—°íšŒë¹„ ì˜µì…˜ -->
                <div class="form-group">
                    <label>ì—°íšŒë¹„ ì˜µì…˜</label>
                    <p class="help-text">ì¹´ë“œ íƒ€ì…ê³¼ ë¸Œëœë“œë³„ë¡œ ë‹¤ë¥¸ ì—°íšŒë¹„ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                    <div id="annualFeeList" style="margin-top: 15px; margin-bottom: 15px;"></div>
                    <button type="button" class="btn btn-primary" onclick="addAnnualFeeOption()">+ ì—°íšŒë¹„ ì˜µì…˜ ì¶”ê°€</button>
                </div>

                <!-- ì¹´ë“œ í˜œíƒ -->
                <div class="form-group">
                    <label>ì¹´ë“œ í˜œíƒ</label>
                    <div id="benefitsList" style="margin-top: 15px; margin-bottom: 15px;"></div>
                    <button type="button" class="btn btn-primary" onclick="addBenefit()">+ í˜œíƒ ì¶”ê°€</button>
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="saveCard()">ğŸ’¾ ì¹´ë“œ ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="resetForm()">ğŸ”„ ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>

        <!-- ì¹´ë“œ ê´€ë¦¬ íƒ­ -->
        <div id="listTab" class="tab-content">
            <div class="panel">
                <h2>ë“±ë¡ëœ ì¹´ë“œ ëª©ë¡</h2>

                <div id="cardListContainer" class="card-list"></div>

                <div id="emptyState" class="alert alert-info" style="text-align: center;">
                    ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤. "ì¹´ë“œ ì¶”ê°€" íƒ­ì—ì„œ ìƒˆ ì¹´ë“œë¥¼ ë“±ë¡í•˜ì„¸ìš”.
                </div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = 'admin1234';
        const API_ENDPOINT = '/.netlify/functions/manage-cards';

        let benefitCounter = 0;
        let annualFeeCounter = 0;
        let tierCounters = {}; // benefitId -> tierCounter
        let editingCardId = null;
        let allCardsData = { cards: [], categories: [] }; // APIì—ì„œ ë¡œë“œí•œ ì „ì²´ ë°ì´í„°

        const categories = [
            { id: 'ì „ì²´', name: 'ì „ì²´ (ëª¨ë“  ì—…ì¢…)', icon: 'ğŸ’³' },
            { id: 'ì‹ë¹„', name: 'ì‹ë¹„', icon: 'ğŸ´' },
            { id: 'ì‡¼í•‘', name: 'ì‡¼í•‘', icon: 'ğŸ›ï¸' },
            { id: 'ì¹´í˜', name: 'ì¹´í˜/ë””ì €íŠ¸', icon: 'â˜•' },
            { id: 'êµí†µ', name: 'êµí†µ/ì£¼ìœ ', icon: 'ğŸš—' },
            { id: 'í†µì‹ ', name: 'í†µì‹ ', icon: 'ğŸ“±' },
            { id: 'í¸ì˜ì ', name: 'í¸ì˜ì ', icon: 'ğŸª' },
            { id: 'OTT', name: 'OTT/êµ¬ë…', icon: 'ğŸ“º' },
            { id: 'ì˜¨ë¼ì¸ì‡¼í•‘', name: 'ì˜¨ë¼ì¸ì‡¼í•‘', icon: 'ğŸ–¥ï¸' },
            { id: 'ë°°ë‹¬', name: 'ë°°ë‹¬ì•±', icon: 'ğŸ›µ' },
            { id: 'ì˜í™”', name: 'ì˜í™”/ë¬¸í™”', icon: 'ğŸ¬' },
            { id: 'ë³‘ì›', name: 'ë³‘ì›/ì•½êµ­', icon: 'ğŸ¥' },
            { id: 'ë·°í‹°', name: 'ë·°í‹°/ë¯¸ìš©', icon: 'ğŸ’…' }
        ];

        // ì¹´í…Œê³ ë¦¬ë³„ ì£¼ìš” ë¸Œëœë“œ
        const categoryBrands = {
            'ì¹´í˜': ['ìŠ¤íƒ€ë²…ìŠ¤', 'ì´ë””ì•¼', 'íˆ¬ì¸í”Œë ˆì´ìŠ¤', 'ì»¤í”¼ë¹ˆ', 'í• ë¦¬ìŠ¤', 'ë¹½ë‹¤ë°©', 'ë©”ê°€ì»¤í”¼', 'ì»´í¬ì¦ˆì»¤í”¼'],
            'í¸ì˜ì ': ['GS25', 'CU', 'ì„¸ë¸ì¼ë ˆë¸', 'ì´ë§ˆíŠ¸24', 'ë¯¸ë‹ˆìŠ¤í†±'],
            'ë°°ë‹¬': ['ë°°ë‹¬ì˜ë¯¼ì¡±', 'ì¿ íŒ¡ì´ì¸ ', 'ìš”ê¸°ìš”'],
            'ì˜¨ë¼ì¸ì‡¼í•‘': ['ì¿ íŒ¡', '11ë²ˆê°€', 'Gë§ˆì¼“', 'ì˜¥ì…˜', 'ì¸í„°íŒŒí¬', 'SSGë‹·ì»´', 'ë„¤ì´ë²„ì‡¼í•‘'],
            'OTT': ['ë„·í”Œë¦­ìŠ¤', 'ì›¨ì´ë¸Œ', 'ì™“ì± ', 'ë””ì¦ˆë‹ˆí”ŒëŸ¬ìŠ¤', 'í‹°ë¹™', 'ì¿ íŒ¡í”Œë ˆì´'],
            'êµí†µ': ['ì§€í•˜ì² ', 'ë²„ìŠ¤', 'KTX', 'SRT', 'íƒì‹œ', 'SKì—ë„ˆì§€', 'GSì¹¼í…ìŠ¤', 'S-OIL', 'í˜„ëŒ€ì˜¤ì¼ë±…í¬'],
            'í†µì‹ ': ['SKT', 'KT', 'LGìœ í”ŒëŸ¬ìŠ¤'],
            'ì‹ë¹„': ['ì™¸ì‹', 'ë°°ë‹¬', 'ìŒì‹ì '],
            'ì‡¼í•‘': ['ë°±í™”ì ', 'ì•„ìš¸ë ›', 'ëŒ€í˜•ë§ˆíŠ¸'],
            'ì˜í™”': ['CGV', 'ë¡¯ë°ì‹œë„¤ë§ˆ', 'ë©”ê°€ë°•ìŠ¤'],
            'ë³‘ì›': ['ë³‘ì›', 'ì•½êµ­', 'ì˜ì›'],
            'ë·°í‹°': ['ì˜¬ë¦¬ë¸Œì˜', 'ë„ë¼ë¸”ë¼', 'ë·°í‹°í”Œë ‰ìŠ¤', 'ë¯¸ìš©ì‹¤']
        };

        // ë¡œê·¸ì¸ ì²´í¬
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('loginError');
            const password = input.value;

            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                sessionStorage.setItem('adminAuth', 'true');
                initializeForm();
                loadCardList();
            } else {
                error.textContent = 'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                error.classList.remove('hidden');
                input.value = '';
                input.focus();
                setTimeout(() => error.classList.add('hidden'), 3000);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        window.addEventListener('DOMContentLoaded', () => {
            const isAuthenticated = sessionStorage.getItem('adminAuth') === 'true';
            if (isAuthenticated) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                initializeForm();
                loadCardList();
            } else {
                document.getElementById('passwordInput').focus();
            }
        });

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            if (tabName === 'add') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('addTab').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('listTab').classList.add('active');
                loadCardList();
            }
        }

        // ì´ˆê¸° í¼ ì„¸íŒ…
        function initializeForm() {
            if (benefitCounter === 0 && annualFeeCounter === 0) {
                addAnnualFeeOption();
                addBenefit();
            }
        }

        // ì—°íšŒë¹„ ì˜µì…˜ ì¶”ê°€
        function addAnnualFeeOption() {
            annualFeeCounter++;
            const html = `
                <div class="fee-option-item" id="fee-${annualFeeCounter}">
                    <div class="item-header">
                        <div class="item-number" style="background: #ff9800;">${annualFeeCounter}</div>
                        <button class="remove-btn" onclick="removeFeeOption(${annualFeeCounter})">ì‚­ì œ</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ì¹´ë“œ íƒ€ì…</label>
                            <select class="fee-type">
                                <option value="êµ­ë‚´ì „ìš©">êµ­ë‚´ì „ìš©</option>
                                <option value="í•´ì™¸ê²¸ìš©">í•´ì™¸ê²¸ìš©</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ì¹´ë“œ ë¸Œëœë“œ (ì„ íƒ)</label>
                            <select class="fee-brand">
                                <option value="">ì„ íƒì•ˆí•¨</option>
                                <option value="VISA">VISA</option>
                                <option value="Mastercard">Mastercard</option>
                                <option value="AMEX">AMEX</option>
                                <option value="JCB">JCB</option>
                                <option value="UnionPay">UnionPay</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>ì—°íšŒë¹„ (ì›)</label>
                            <input type="number" class="fee-amount" placeholder="10000" step="1000" value="0">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('annualFeeList').insertAdjacentHTML('beforeend', html);
        }

        function removeFeeOption(id) {
            document.getElementById(`fee-${id}`).remove();
        }

        // í˜œíƒ ì¶”ê°€
        function addBenefit() {
            benefitCounter++;
            tierCounters[benefitCounter] = 0;

            const html = `
                <div class="benefit-item" id="benefit-${benefitCounter}">
                    <div class="item-header">
                        <div class="item-number">${benefitCounter}</div>
                        <button class="remove-btn" onclick="removeBenefit(${benefitCounter})">ì‚­ì œ</button>
                    </div>

                    <div class="form-group">
                        <label>í˜œíƒ ì¹´í…Œê³ ë¦¬</label>
                        <select class="benefit-category" onchange="updateAffiliateOptions(${benefitCounter})">
                            ${categories.map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ì œíœ´ì²˜ ë²”ìœ„ *</label>
                        <select class="benefit-scope" onchange="toggleAffiliateInput(${benefitCounter})">
                            <option value="all">ì „ì²´ (ì¹´í…Œê³ ë¦¬ ë‚´ ëª¨ë“  ê°€ë§¹ì )</option>
                            <option value="major">ì£¼ìš” í”„ëœì°¨ì´ì¦ˆë§Œ</option>
                            <option value="specific">íŠ¹ì • ë¸Œëœë“œë§Œ (ì§ì ‘ ì…ë ¥)</option>
                        </select>
                        <p class="help-text">ì‚¬ìš©ìê°€ ì–´ëŠ ë§¤ì¥ì—ì„œ í˜œíƒì„ ë°›ì„ ìˆ˜ ìˆëŠ”ì§€ ëª…í™•íˆ ì„¤ì •í•˜ì„¸ìš”</p>
                    </div>

                    <div class="form-group affiliate-input" id="affiliateInput-${benefitCounter}" style="display:none;">
                        <label>ì œíœ´ ë¸Œëœë“œ</label>
                        <input type="text" class="benefit-affiliates" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤,ì´ë””ì•¼,íˆ¬ì¸í”Œë ˆì´ìŠ¤">
                        <p class="help-text">ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”</p>
                        <div id="affiliateSuggestions-${benefitCounter}" class="affiliate-suggestions"></div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>í˜œíƒ íƒ€ì…</label>
                            <select class="benefit-type">
                                <option value="discount">í• ì¸</option>
                                <option value="point">í¬ì¸íŠ¸ ì ë¦½</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ì„¤ëª… (ìë™ ìƒì„±ë¨)</label>
                            <input type="text" class="benefit-description" placeholder="ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" class="use-tiers" id="useTiers-${benefitCounter}" onchange="toggleTiers(${benefitCounter})">
                            <label for="useTiers-${benefitCounter}" style="margin: 0;">ì „ì›”ì‹¤ì  êµ¬ê°„ë³„ í˜œíƒ ì‚¬ìš©</label>
                        </div>
                        <p class="help-text">ì²´í¬í•˜ë©´ ì „ì›”ì‹¤ì ì— ë”°ë¼ ë‹¤ë¥¸ í˜œíƒì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                    </div>

                    <!-- ë‹¨ì¼ í˜œíƒ (ê¸°ë³¸) -->
                    <div id="singleBenefit-${benefitCounter}" class="single-benefit">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>í• ì¸ìœ¨/ì ë¦½ë¥  (%)</label>
                                <input type="number" class="benefit-rate" placeholder="10" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>ì›” ìµœëŒ€ í•œë„ (ì›)</label>
                                <input type="number" class="benefit-max" placeholder="10000" step="1000">
                            </div>
                        </div>
                    </div>

                    <!-- êµ¬ê°„ë³„ í˜œíƒ -->
                    <div id="tieredBenefit-${benefitCounter}" class="tiered-benefit hidden">
                        <div id="tiersList-${benefitCounter}"></div>
                        <button type="button" class="btn btn-primary" onclick="addTier(${benefitCounter})">+ ì‹¤ì  êµ¬ê°„ ì¶”ê°€</button>
                    </div>
                </div>
            `;
            document.getElementById('benefitsList').insertAdjacentHTML('beforeend', html);
        }

        function removeBenefit(id) {
            document.getElementById(`benefit-${id}`).remove();
            delete tierCounters[id];
        }

        function toggleTiers(benefitId) {
            const useTiers = document.getElementById(`useTiers-${benefitId}`).checked;
            const singleBenefit = document.getElementById(`singleBenefit-${benefitId}`);
            const tieredBenefit = document.getElementById(`tieredBenefit-${benefitId}`);

            if (useTiers) {
                singleBenefit.classList.add('hidden');
                tieredBenefit.classList.remove('hidden');
                if (tierCounters[benefitId] === 0) {
                    addTier(benefitId);
                }
            } else {
                singleBenefit.classList.remove('hidden');
                tieredBenefit.classList.add('hidden');
            }
        }

        function addTier(benefitId) {
            tierCounters[benefitId]++;
            const tierId = tierCounters[benefitId];

            const html = `
                <div class="tier-item" id="tier-${benefitId}-${tierId}">
                    <div class="item-header">
                        <div class="item-number" style="background: #4a90e2;">êµ¬ê°„ ${tierId}</div>
                        <button class="remove-btn" onclick="removeTier(${benefitId}, ${tierId})">ì‚­ì œ</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ì „ì›”ì‹¤ì  (ì› ì´ìƒ)</label>
                            <input type="number" class="tier-min" placeholder="300000" step="10000" value="0">
                            <p class="help-text">ì´ ê¸ˆì•¡ ì´ìƒ ì‚¬ìš© ì‹œ ì•„ë˜ í˜œíƒ ì ìš©</p>
                        </div>
                        <div class="form-group">
                            <label>í• ì¸ìœ¨/ì ë¦½ë¥  (%)</label>
                            <input type="number" class="tier-rate" placeholder="10" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>ì›” ìµœëŒ€ í•œë„ (ì›)</label>
                            <input type="number" class="tier-max" placeholder="10000" step="1000">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById(`tiersList-${benefitId}`).insertAdjacentHTML('beforeend', html);
        }

        function removeTier(benefitId, tierId) {
            document.getElementById(`tier-${benefitId}-${tierId}`).remove();
        }

        // ì œíœ´ì²˜ ì…ë ¥ í† ê¸€
        function toggleAffiliateInput(benefitId) {
            const benefitItem = document.getElementById(`benefit-${benefitId}`);
            const scope = benefitItem.querySelector('.benefit-scope').value;
            const affiliateInput = document.getElementById(`affiliateInput-${benefitId}`);

            if (scope === 'specific') {
                affiliateInput.style.display = 'block';
            } else {
                affiliateInput.style.display = 'none';
            }

            updateDescription(benefitId);
        }

        // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ì œíœ´ì²˜ ì œì•ˆ ì—…ë°ì´íŠ¸
        function updateAffiliateOptions(benefitId) {
            const benefitItem = document.getElementById(`benefit-${benefitId}`);
            const category = benefitItem.querySelector('.benefit-category').value;
            const suggestionsDiv = document.getElementById(`affiliateSuggestions-${benefitId}`);

            const brands = categoryBrands[category] || [];
            if (brands.length > 0) {
                suggestionsDiv.innerHTML = `
                    <div style="margin-top: 10px;">
                        <strong>ì¶”ì²œ ë¸Œëœë“œ:</strong><br>
                        ${brands.map(brand => `<span class="brand-tag" onclick="addBrandToInput(${benefitId}, '${brand}')">${brand}</span>`).join(' ')}
                    </div>
                `;
            } else {
                suggestionsDiv.innerHTML = '';
            }

            updateDescription(benefitId);
        }

        // ë¸Œëœë“œ íƒœê·¸ í´ë¦­ ì‹œ ì…ë ¥ë€ì— ì¶”ê°€
        function addBrandToInput(benefitId, brand) {
            const benefitItem = document.getElementById(`benefit-${benefitId}`);
            const input = benefitItem.querySelector('.benefit-affiliates');
            const current = input.value.trim();

            if (current) {
                const brands = current.split(',').map(b => b.trim());
                if (!brands.includes(brand)) {
                    input.value = current + ',' + brand;
                }
            } else {
                input.value = brand;
            }

            updateDescription(benefitId);
        }

        // ì„¤ëª… ìë™ ìƒì„±
        function updateDescription(benefitId) {
            const benefitItem = document.getElementById(`benefit-${benefitId}`);
            const category = benefitItem.querySelector('.benefit-category').value;
            const scope = benefitItem.querySelector('.benefit-scope').value;
            const affiliates = benefitItem.querySelector('.benefit-affiliates')?.value || '';
            const type = benefitItem.querySelector('.benefit-type').value;
            const descInput = benefitItem.querySelector('.benefit-description');

            let description = '';

            if (scope === 'all') {
                const categoryName = categories.find(c => c.id === category)?.name || category;
                description = `ì „ì²´ ${categoryName}`;
            } else if (scope === 'major') {
                const categoryName = categories.find(c => c.id === category)?.name || category;
                description = `ì£¼ìš” ${categoryName} í”„ëœì°¨ì´ì¦ˆ`;
            } else if (scope === 'specific' && affiliates) {
                description = affiliates.replace(/,/g, 'Â·');
            }

            descInput.value = description;
        }

        // ì¹´ë“œ ì €ì¥
        async function saveCard() {
            const cardName = document.getElementById('cardName').value;
            const cardIssuer = document.getElementById('cardIssuer').value;

            if (!cardName || !cardIssuer) {
                alert('ì¹´ë“œëª…ê³¼ ë°œê¸‰ì‚¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // ì—°íšŒë¹„ ì˜µì…˜ ìˆ˜ì§‘
            const annualFeeOptions = [];
            document.querySelectorAll('.fee-option-item').forEach(item => {
                const type = item.querySelector('.fee-type').value;
                const brand = item.querySelector('.fee-brand').value;
                const fee = parseInt(item.querySelector('.fee-amount').value) || 0;
                annualFeeOptions.push({ type, brand: brand || null, fee });
            });

            if (annualFeeOptions.length === 0) {
                annualFeeOptions.push({ type: 'êµ­ë‚´ì „ìš©', brand: null, fee: 0 });
            }

            // í˜œíƒ ìˆ˜ì§‘
            const benefits = [];
            document.querySelectorAll('.benefit-item').forEach(item => {
                const category = item.querySelector('.benefit-category').value;
                const type = item.querySelector('.benefit-type').value;
                const description = item.querySelector('.benefit-description').value;
                const scope = item.querySelector('.benefit-scope').value;
                const affiliates = item.querySelector('.benefit-affiliates')?.value || '';
                const useTiers = item.querySelector('.use-tiers').checked;

                // ì œíœ´ì²˜ ì •ë³´ ì²˜ë¦¬
                let affiliateList = '';
                if (scope === 'specific' && affiliates) {
                    affiliateList = affiliates.trim();
                } else if (scope === 'all') {
                    affiliateList = 'ALL';
                } else if (scope === 'major') {
                    affiliateList = 'MAJOR';
                }

                if (useTiers) {
                    // êµ¬ê°„ë³„ í˜œíƒ
                    const tiers = [];
                    item.querySelectorAll('.tier-item').forEach(tierItem => {
                        const minPreviousMonth = parseInt(tierItem.querySelector('.tier-min').value) || 0;
                        const rate = parseFloat(tierItem.querySelector('.tier-rate').value) || 0;
                        const maxMonthly = parseInt(tierItem.querySelector('.tier-max').value) || 0;
                        tiers.push({ minPreviousMonth, rate, maxMonthly });
                    });
                    benefits.push({ category, type, description, scope, affiliates: affiliateList, tiers });
                } else {
                    // ë‹¨ì¼ í˜œíƒ
                    const rate = parseFloat(item.querySelector('.benefit-rate').value) || 0;
                    const maxMonthly = parseInt(item.querySelector('.benefit-max').value) || 0;
                    benefits.push({ category, type, rate, maxMonthly, description, scope, affiliates: affiliateList });
                }
            });

            const cardId = editingCardId || 'card_' + Date.now();
            const cardData = {
                id: cardId,
                name: cardName,
                issuer: cardIssuer,
                benefits: benefits,
                annualFee: { options: annualFeeOptions }
            };

            try {
                // Google Sheets API í˜¸ì¶œ
                const method = editingCardId ? 'PUT' : 'POST';
                const body = editingCardId ? { cardId, cardData } : cardData;

                const response = await fetch(API_ENDPOINT, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'ì €ì¥ ì‹¤íŒ¨');
                }

                alert('âœ… ì¹´ë“œê°€ êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                resetForm();
                editingCardId = null;
                loadCardList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message + '\n\nêµ¬ê¸€ ì‹œíŠ¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
            }
        }

        // í¼ ì´ˆê¸°í™”
        function resetForm() {
            document.getElementById('cardName').value = '';
            document.getElementById('cardIssuer').value = '';
            document.getElementById('annualFeeList').innerHTML = '';
            document.getElementById('benefitsList').innerHTML = '';
            benefitCounter = 0;
            annualFeeCounter = 0;
            tierCounters = {};
            editingCardId = null;
            addAnnualFeeOption();
            addBenefit();
        }

        // ì¹´ë“œ ëª©ë¡ ë¡œë“œ (Google Sheetsì—ì„œ)
        async function loadCardList() {
            const container = document.getElementById('cardListContainer');
            const emptyState = document.getElementById('emptyState');

            try {
                const response = await fetch(API_ENDPOINT);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }

                allCardsData = data;

                if (!data.cards || data.cards.length === 0) {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }

                emptyState.style.display = 'none';
                container.innerHTML = data.cards.map(card => `
                    <div class="card-item">
                        <h3>${card.name}</h3>
                        <p><strong>ë°œê¸‰ì‚¬:</strong> ${card.issuer}</p>
                        <p><strong>í˜œíƒ ìˆ˜:</strong> ${card.benefits.length}ê°œ</p>
                        <p><strong>ì—°íšŒë¹„ ì˜µì…˜:</strong> ${card.annualFee.options.length}ê°œ</p>
                        <div class="card-item-actions">
                            <button class="btn btn-primary" onclick="editCard('${card.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-danger" onclick="deleteCard('${card.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('ì¹´ë“œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                container.innerHTML = `<div class="alert alert-info">âš ï¸ ì¹´ë“œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}</div>`;
                emptyState.style.display = 'none';
            }
        }

        // ì¹´ë“œ ìˆ˜ì •
        function editCard(cardId) {
            const card = allCardsData.cards.find(c => c.id === cardId);
            if (!card) {
                alert('ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // í¼ ì´ˆê¸°í™”
            resetForm();
            editingCardId = cardId;

            // ê¸°ë³¸ ì •ë³´
            document.getElementById('cardName').value = card.name;
            document.getElementById('cardIssuer').value = card.issuer;

            // ì—°íšŒë¹„ ì˜µì…˜
            document.getElementById('annualFeeList').innerHTML = '';
            annualFeeCounter = 0;
            card.annualFee.options.forEach(opt => {
                addAnnualFeeOption();
                const item = document.getElementById(`fee-${annualFeeCounter}`);
                item.querySelector('.fee-type').value = opt.type;
                item.querySelector('.fee-brand').value = opt.brand || '';
                item.querySelector('.fee-amount').value = opt.fee;
            });

            // í˜œíƒ
            document.getElementById('benefitsList').innerHTML = '';
            benefitCounter = 0;
            card.benefits.forEach(benefit => {
                addBenefit();
                const item = document.getElementById(`benefit-${benefitCounter}`);
                item.querySelector('.benefit-category').value = benefit.category;
                item.querySelector('.benefit-type').value = benefit.type;
                item.querySelector('.benefit-description').value = benefit.description || '';

                // ì œíœ´ì²˜ ì •ë³´ ë¡œë“œ
                if (benefit.scope) {
                    item.querySelector('.benefit-scope').value = benefit.scope;
                    toggleAffiliateInput(benefitCounter);
                }
                if (benefit.affiliates && benefit.affiliates !== 'ALL' && benefit.affiliates !== 'MAJOR') {
                    item.querySelector('.benefit-affiliates').value = benefit.affiliates;
                }

                if (benefit.tiers && benefit.tiers.length > 0) {
                    // êµ¬ê°„ë³„ í˜œíƒ
                    item.querySelector('.use-tiers').checked = true;
                    toggleTiers(benefitCounter);

                    benefit.tiers.forEach(tier => {
                        addTier(benefitCounter);
                        const tierItem = document.querySelector(`#tiersList-${benefitCounter} .tier-item:last-child`);
                        tierItem.querySelector('.tier-min').value = tier.minPreviousMonth;
                        tierItem.querySelector('.tier-rate').value = tier.rate;
                        tierItem.querySelector('.tier-max').value = tier.maxMonthly;
                    });
                } else {
                    // ë‹¨ì¼ í˜œíƒ
                    item.querySelector('.benefit-rate').value = benefit.rate || 0;
                    item.querySelector('.benefit-max').value = benefit.maxMonthly || 0;
                }
            });

            switchTab('add');
            alert('ìˆ˜ì • ëª¨ë“œì…ë‹ˆë‹¤. ë³€ê²½ í›„ ì €ì¥í•˜ì„¸ìš”.');
        }

        // ì¹´ë“œ ì‚­ì œ
        async function deleteCard(cardId) {
            if (!confirm('ì •ë§ ì´ ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cardId })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'ì‚­ì œ ì‹¤íŒ¨');
                }

                alert('âœ… ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadCardList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }
    </script>
</body>
</html>
